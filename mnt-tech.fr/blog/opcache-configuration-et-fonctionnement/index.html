<!DOCTYPE html>
<html lang="fr" >

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<meta property="og:title" content="Fonctionnement et configuration d&#39;OPcache" />
<meta property="og:description" content="Fonctionnement et configuration d&#39;OPcache de PHP." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://igln.fr/opcache-configuration-et-fonctionnement/" />
<meta property="article:published_time" content="2017-02-01T14:54:37+02:00" />
<meta property="article:modified_time" content="2017-02-01T14:54:37+02:00" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Fonctionnement et configuration d&#39;OPcache"/>
<meta name="twitter:description" content="Fonctionnement et configuration d&#39;OPcache de PHP."/>
<meta name="generator" content="Hugo 0.80.0" />



<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Fonctionnement et configuration d'OPcache",
  "url": "https://igln.fr/opcache-configuration-et-fonctionnement/",
  "wordCount": "3057",
  "datePublished": "2017-02-01T14:54:37+02:00",
  "dateModified": "2017-02-01T14:54:37+02:00",
  "author": {
    "@type": "Person",
    "name": "K√©vin Met"
  },
  "keywords": "blog, php, opcache",
  "description": "Fonctionnement et configuration d'OPcache de PHP."
}
</script>



    <link rel="canonical" href="index.html">

    <title>Fonctionnement et configuration d&rsquo;OPcache | Blog IGLN</title>


    <!-- combined, minified CSS -->

    <link href="https://igln.fr/css/style.16633182cd803b52b9bf9e29ea1ef4b2e3d460deee0ded49466d7e16e449c158.css" rel="stylesheet" integrity="sha256-FmMxgs2AO1K5v54p6h70suPUYN7uDe1JRm1&#43;FuRJwVg=" crossorigin="anonymous">


    <!-- minified Font Awesome for SVG icons -->

    <script defer src="https://igln.fr/js/fontawesome.min.4ed405d7c7002b970d34cbe6026ff44a556b0808cb98a9db4008752110ed964b.js" integrity="sha256-TtQF18cAK5cNNMvmAm/0SlVrCAjLmKnbQAh1IRDtlks=" crossorigin="anonymous"></script>

    <!-- RSS 2.0 feed -->




  </head>

  <body>


    <div class="blog-masthead">
      <div class="container">
        <nav class="nav blog-nav">
          <a class="nav-link " href="https://igln.fr/">Accueil</a>
        </nav>
      </div>
    </div>




    <header class="blog-header">
      <div class="container">
        <h1 class="blog-title" dir="auto"><a href="https://igln.fr/" rel="home">Blog IGLN</a></h1>
        <p class="lead blog-description" dir="auto">Blog autour de l&rsquo;univers SysAdmin/DevOps/SRE.</p>
      </div>
    </header>




    <div class="container">
      <div class="row">
        <div class="col-sm-8 blog-main">




<article class="blog-post">
  <header>
    <h2 class="blog-post-title" dir="auto"><a href="index.html">Fonctionnement et configuration d&rsquo;OPcache</a></h2>
    <p class="blog-post-meta">
<time datetime="2017-02-01T14:54:37+02:00">01 Wed Feb 2017</time>
 in
<span class="fas fa-folder" aria-hidden="true"></span>&nbsp;<a href="https://igln.fr/categories/blog/" rel="category tag">blog</a>


<span class="fas fa-tag" aria-hidden="true"></span>&nbsp;<a href="https://igln.fr/tags/php/" rel="tag">php</a>, <a href="https://igln.fr/tags/opcache/" rel="tag">opcache</a>

</p>
  </header>
  <p>Aujourd‚Äôhui on va parler de <strong>Zend OPcache</strong>, un sujet qui peut sembler un peu fade car c‚Äôest quelque chose qu‚Äôon manipule assez r√©guli√®rement depuis qu‚Äôil est inclus dans PHP mais finalement, j‚Äôai quand m√™me trouv√© pas mal de chose √† raconter et je vais essayer d‚Äôaller un peu en profondeur au long de cet article. C‚Äôest bien d‚Äôavoir de l‚Äôambition en d√©but d‚Äôarticle, on verra si je tiens mes promesses&hellip; üòâ</p>
<h3 id="historique">Historique</h3>
<p>A la base, OPcache se nommait <strong>Zend Optimizer+</strong> et √©tait payant donc assez peu utilis√© surtout qu‚Äôil avait des concurrents gratuits et qui fonctionnaient tr√®s bien. Il y avait, entre autres <strong>APC</strong>, <strong>eAccelerator</strong>, <strong>Xcache</strong> et j‚Äôen oublie volontairement d‚Äôautres&hellip; APC devait m√™me √™tre int√©gr√© √† la version 6 de PHP qui n‚Äôa jamais vu le jour. Par la suite Zend Optimizer+ a √©t√© rendu open source et int√©gr√© √† partir de la <strong>version 5.5</strong> dans le core de PHP ce qui fait qu‚Äôil domine maintenant tr√®s largement le march√©.</p>
<h3 id="diff√©rences-entre-apc-et-opcache">Diff√©rences entre APC et OPcache</h3>
<p>Pour poursuivre un peu avec le dernier paragraphe on a souvent pr√©sent√© OPcache comme le rempla√ßant direct d‚ÄôAPC, ce qui n‚Äôest pas tout √† fait vrai car il ne reprend pas les m√™me fonctionnalit√©s. En effet, APC permettait de <strong>cacher l‚Äôopcode</strong> g√©n√©r√© par PHP et de <strong>g√©rer un cache utilisateur</strong>, le <strong>data store</strong>, alors que Zend OPcache permet <strong>d‚Äôoptimiser et de cacher</strong> l‚Äôopcode g√©n√©r√© par PHP. La diff√©rence est donc de taille car on ne retrouve pas la fonction de data store dans OPcache et c‚Äôest pourquoi il existe une nouvelle extension PHP nomm√© <a href="http://php.net/manual/en/book.apcu.php">APCu</a> qui reprend le code d‚ÄôAPC en ne conservant que la partie cache utilisateur. Par contre APC ne faisait pas d&rsquo;optimisation du bytecode ce qu&rsquo;ajoute OPcache.</p>
<h3 id="principe-de-fonctionnement-de-zend-opcache">Principe de fonctionnement de Zend OPcache</h3>
<p>Maintenant qu‚Äôon a vu ces diff√©rences on va rentrer un peu plus en d√©tail dans le fonctionnement d‚ÄôOPcache. Comme je l‚Äôexpliquais pr√©c√©demment, il permet de faire deux choses bien distinctes, une partie <strong>optimise le bytecode</strong> et l‚Äôautre le <strong>met en cache dans la m√©moire partag√©e</strong>. Ces deux fonctions permettent donc d‚Äôapporter un gain non n√©gligeable √† votre applicatif PHP. Mais qu‚Äôest-ce que l‚Äôopcode exactement ? Et bien lorsque PHP interpr√®te un fichier source il passe par plusieurs phases. Il commence par faire une <strong>analyse syntaxique</strong> (parser + lexer) du code source en PHP, il <strong>compile ensuite en opcode</strong> (la liste compl√®te des opcodes <a href="http://php.net/manual/en/internals2.opcodes.php">ici</a>) et enfin il <strong>ex√©cute cet opcode</strong> qui donne le r√©sultat.</p>
<p>Voici un superbe sch√©ma que j‚Äôai r√©alis√© sur mon beau tableau blanc pour repr√©senter tout cela et vous allez voir que mes talents de dessinateurs sont dignes de Van Gogh üòÑ</p>








<figure>
    <img


            src="https://igln.fr/2017/02/php-opcode-compilation.jpg"

            alt="php opcode compilation"/> <figcaption>
            <h4>php opcode compilation</h4>
        </figcaption>
</figure>

<p>Maintenant que j‚Äôai perdu toute cr√©dibilit√© gr√¢ce √† ce sch√©ma on va voir o√π intervient le Zend OPcache avec&hellip; un autre sch√©ma !</p>








<figure>
    <img


            src="https://igln.fr/2017/02/php-opcache-opcode.jpg"

            alt="php opcache opcode"/> <figcaption>
            <h4>php opcache opcode</h4>
        </figcaption>
</figure>

<p>Bon, promis, j‚Äôarr√™te avec mes sch√©mas d√©gueulasses. On voit donc qu‚ÄôOPcache intervient <strong>apr√®s la compilation en optimisant l‚Äôopcode et en le cachant en m√©moire partag√©e</strong>. Lors du prochain appel √† ce script PHP, Zend Engine sera donc capable d‚Äôaller v√©rifier si le <strong>bytecode</strong> est dans la m√©moire et directement l‚Äôexploiter si c‚Äôest le cas, ce qui repr√©sente un gain assez important car on s‚Äô√©vite une lecture du fichier sur le disque, une analyse syntaxique et une compilation. Dans la suite de l&rsquo;article j&rsquo;utiliserai <strong>bytecode ou opcode</strong> car c&rsquo;est la m√™me chose, du <strong>code interm√©diaire</strong></p>
<h3 id="la-partie-optimisation">La partie optimisation</h3>
<p>L‚Äôoptimisation est la partie qui ne demande aucun r√©glage car elle est activ√©e par d√©faut au plus haut niveau et elle fonctionne parfaitement. En gros, cette partie s‚Äôoccupe de <strong>virer tout les opcodes inutiles</strong> apr√®s que Zend Engine soit pass√©. Par exemple, les conditions qui ne seront jamais vraies, les exit superflus et tout un tas d‚Äôautres trucs. Si jamais vous avez envie de faire du tuning sur cette partie cela passe par l‚Äôutilisation de cette variable de configuration : <strong>opcache.optimization_level</strong>. Il faut √©galement savoir que de nombreuses optimisations pr√©sentes dans OPcache sont directement pass√©es dans Zend Engine dans la version 7 de PHP.</p>
<p>Concr√®tement cela donne quoi ? On va voir un petit exemple avec un script assez basique et l‚Äôextension <a href="https://pecl.php.net/package/vld">vld</a> qui permet de dumper le bytecode avant qu‚Äôil soit ex√©cut√©. Voici le script en question :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">true</span>) {
  <span style="color:#66d9ef">echo</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>;
} <span style="color:#66d9ef">else</span> {
  <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;KO&#34;</span>;
}
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Voici le bytecode sans utilisation d‚ÄôOPcache :</p>
<pre><code>line     #* E I O op                           fetch          ext  return  operands
-------------------------------------------------------------------------------------
   2     0  E &gt; &gt; JMPZ                                                     &lt;true&gt;, -&gt;3
   3     1    &gt;   ECHO                                                     3
         2      &gt; JMP                                                      -&gt;4
   5     3    &gt;   ECHO                                                     'KO'
   8     4    &gt; &gt; RETURN                                                   1
</code></pre><p>On voit qu‚Äôon a des opcodes qui ne servent √† rien, le JPMZ, le JMP et le ECHO &lsquo;KO&rsquo;. Voici la version avec OPcache activ√© :</p>
<pre><code>    line     #* E I O op                           fetch          ext  return  operands
    -------------------------------------------------------------------------------------
       3     0  E &gt;   ECHO                                                     3
       8     1      &gt; RETURN                                                   1
</code></pre><p>On peut voir le <strong>gain en efficacit√© qu‚Äôapporte OPcache</strong> dans ce genre de situation assez caricaturale. En situation r√©elle, on s‚Äôaccorde √† dire que la partie optimisation n‚Äôapporte qu‚Äôun gain de 10 % (cf pas de sources mais tu peux me croire sur parole). Tout cela d√©pend bien √©videmment de la fa√ßon dont votre code est √©crit et optimis√© √† la base.</p>
<p>Il y a une seconde optimisation qui est faite via OPcache et qui concerne les <strong>cha√Ænes de caract√®res</strong> dans votre code. Toutes les cha√Ænes identiques vont √™tre <strong>stock√©es en m√©moire dans un seul pointeur</strong> et celui-ci sera appel√© √† chaque fois que le code utilise cette cha√Æne. Cela √©vite de faire une allocation m√©moire √† chaque fois qu‚Äôune cha√Æne similaire est d√©tect√©e.</p>
<h3 id="la-partie-cache">La partie cache</h3>
<p>L√† on attaque le gros du sujet car c‚Äôest l√† que la configuration par d√©faut est vraiment moisie et qu‚Äôil faut faire le plus de changements. En plus de cela il faut faire des choix sur la fa√ßon dont on va fonctionner pour invalider le cache. D√©j√† on va bien distinguer entre la dev et la prod car on ne veut √©videmment pas que les devs nous tombent dessus car l‚Äôenvironnement de dev ne refl√®te pas les changements qui sont apport√©s aux sources de l‚Äôapplicatif. On va donc commencer par voir les diff√©rents m√©canismes d‚Äôinvalidation en listant quelques options de configuration relatives √† ce sujet.</p>
<p>Il faut savoir qu‚Äôau lancement d‚ÄôOPcache, que ce soit via le <strong>mod_php d‚Äôapache</strong> ou via un <strong>pool php-fpm</strong>, celui-ci va allouer une partie de la m√©moire qu‚Äôil <strong>divisera en plusieurs segments</strong> lui m√™me et qui ne sera <strong>jamais lib√©r√© durant la vie du processus</strong>. La taille de ce morceau de m√©moire est d√©fini par le param√®tre <strong>opcache.memory_consumption</strong> et est donc invariable durant toute la vie du processus php mais on en reparlera plus en d√©tail par la suite.</p>
<h3 id="revalidation-via-timestamp">Revalidation via timestamp</h3>
<p>Ce type de revalidation du cache fonctionne avec deux param√®tres :</p>
<ul>
<li><strong>opcache.validate_timestamps</strong></li>
<li><strong>opcache.revalidate_freq</strong></li>
</ul>
<p><strong>opcache.validate_timestamps</strong> est un bool√©en qui active ou non la revalidation via timestamp (par d√©faut √† true) et <strong>opcache.revalidate_freq</strong> est le temps en secondes avant lequel un script doit √™tre revalid√© (par d√©faut deux secondes). Si on met la valeur de opcache.revalidate_freq √† z√©ro le fichier PHP sera revalid√© √† chaque requ√™te.</p>
<p>Si je r√©sume, par d√©faut, OPcache va v√©rifier au maximum 2 fois par secondes si le timestamp du fichier a chang√© avant de l‚Äôex√©cuter. Ce type de m√©canisme n‚Äôest pas id√©al en production et ce m√™me si on met une grande valeur √† <strong>opcache.revalidate_freq</strong> car on utilise des acc√®s disques pour v√©rifier les timestamp des fichiers. Dans un environnement qu‚Äôon conna√Æt bien, c‚Äôest √† dire dans lequel on travaille avec les d√©veloppeurs qui poussent en prod les mises √† jour, il faut totalement <strong>d√©sactiver ce m√©canisme de revalidation par timestamp</strong> et recharger le cache via un autre m√©canisme qu‚Äôon verra plus tard dans l‚Äôarticle.</p>
<p>Si par contre on est dans un environnement tr√®s h√©t√©rog√®ne dans lequel on ne sait pas quand les majs seront pouss√©es ni ce qui tourne sur le serveur, c‚Äôest typiquement le cas lorsqu‚Äôon bosse avec une agence web par exemple, qui a un tas de sites en prod, il est plus prudent de laisser <strong>opcache.validate_timestamps</strong> activ√© et de monter la valeur de <strong>opcache.revalidate_freq</strong>. On va perdre un peu en performances mais les mises √† jour seront visibles en un maximum de <strong>opcache.revalidate_freq secondes</strong>.</p>
<p>Pour l‚Äôenvironnement de dev, on peut √™tre tenter de d√©sactiver compl√®tement OPcache mais il est souvent int√©ressant de rester iso avec la prod pour √©viter un bug qui lui serait li√©. Dans ce cas on peut partir sur un <strong>opcache.revalidate_freq</strong> √† 0 qui revalidera le fichier √† chaque requ√™te.</p>
<p>Dans la suite de l‚Äôarticle on va passer en revue les diff√©rents param√®tres de configuration et voir comment ils fonctionnent et comment les adapter en fonction de la situation.</p>
<h3 id="opcacheenable">opcache.enable</h3>
<p>L√†, c‚Äôest simple c‚Äôest ce qui indique si OPcache va √™tre actif ou non. En effet, il ne suffit pas de charger l‚Äôextension dans votre <strong>php.ini</strong> pour que OPcache soit actif. (Depuis la version 7 de PHP c‚Äôest le contraire et <strong>opcache.enable</strong> est par d√©faut sur <strong>1</strong>.</p>
<p>Je conseille de laisser cette valeur sur 1 en prod, en dev et en test car on est sur de remonter le plus t√¥t possible un √©ventuel bug li√© √† OPcache.</p>
<h3 id="opcachememory_consumption">opcache.memory_consumption</h3>
<p>C‚Äôest la m√©moire utilis√©e pour le <strong>cache d‚Äôopcode et le cache des cl√©s</strong>. √áa me donne une bonne occasion de vous parlez de la fa√ßon interne dont OPcache g√®re le stockage des chemins de scripts, ce qu‚Äôon appelle les cl√©s. Il utilise une <strong>table de hachage</strong>, une hashTable si vous √™tes perdu ;), qui contiendra une cl√© diff√©rente en fonction du param√®tre <strong>opcache.revalidate_path</strong>. Si sa valeur est d√©finit √† 1, le hash contiendra uniquement le chemin complet vers le script PHP alors qu‚Äôen le d√©finissant √† 0 le hash contiendra √©galement les chemins relatifs vers ce fichier. Mais pas de panique, le script php ne sera mis en cache une seule fois. On reviendra plus tard sur ce param√®tre.</p>
<p>Maintenant que vous savez ce que sont ces fameuses cl√©s, il faut donc prendre en compte ce param√®tre lorsque vous allez d√©finir opcache.memory_consumption. La valeur par d√©faut est de 64 en Mo et il faut g√©n√©ralement compter le double de votre espace en fichier php et y ajouter 50 % pour √™tre tranquille. Par exemple, j‚Äôai 20Mo de fichiers PHP, je compte donc 2x20Mo = 40Mo + 50 % = 50Mo. Ceci est un r√®gle pour un premier r√©glage qu‚Äôil faudra affiner ensuite si besoin. A l‚Äôheure actuelle on a la chance d‚Äôavoir beaucoup de RAM donc il ne faut pas h√©siter √† mettre un peu trop sans toutefois exag√©rer.</p>
<p>Une chose tr√®s importante √† avoir en t√™te lorsqu‚Äôon √©tablit cette valeur est que <strong>la m√©moire est partag√©e entre les diff√©rents utilisateurs de PHP</strong> ! Ceci est d‚Äôune importance CAPITALE car cela veut dire que dans un environnement d‚Äôh√©bergement partag√©, le bytecode qui est mis en cache est partag√© entre tous les utilisateurs PHP et ce, m√™me si vous utilisez des utilisateurs unix diff√©rents pour vos pools php. Dans le contexte d‚Äôune agence web dont je parlais plus haut il est donc important de mettre une valeur assez haute et surtout, de <strong>superviser ce cache dans votre outil d‚Äôalerting</strong>. On verra plus bas comment proc√©der et quelles valeurs surveiller.</p>
<h3 id="opcachemax_accelerated_files">opcache.max_accelerated_files</h3>
<p>Par d√©faut sa valeur est √† 2000, c‚Äôest le nombre de fichier php que Zend OPcache pourra mettre en cache. Il faut faire attention √† une petite chose avec ce param√®tre, il prendra comme <strong>valeur r√©elle le premier nombre premier suivant la valeur du param√®tre</strong>. Par exemple √† 2000, la valeur r√©elle est de 2069. Il est donc pr√©f√©rable de mettre directement un nombre premier. Une commande basique pour avoir le nombre de fichiers php dans un dossier :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">find /home/mnttech/www/ -type f -name <span style="color:#e6db74">&#34;*.php&#34;</span> | wc -l
</code></pre></div><h3 id="opcacheinterned_strings_buffer">opcache.interned_strings_buffer</h3>
<p>Par d√©faut √† 4Mo, c‚Äôest la <strong>taille en Mo de la m√©moire allou√©e au stockage des cha√Ænes</strong>. Il est difficile de l‚Äôestimer et il vaut donc mieux allouer un peu trop de m√©moire que pas assez √† ce param√®tre. Il faudra de toute fa√ßon le superviser et on pourra donc ajuster la taille √† la baisse par la suite si n√©cessaire.</p>
<h3 id="opcacherevalidate_path">opcache.revalidate_path</h3>
<p>Comme on l‚Äôa vu pr√©c√©demment ce param√®tre impacte la <strong>taille de la table de hachage contenant les index/cl√©s des scripts mis en cache</strong>. Par d√©faut il est d√©sactiv√©, cela signifie que lorsqu‚Äôun fichier est d√©j√† dans le cache et qu‚Äôil utilise <strong>le m√™me include_path et le m√™me nom</strong>, c&rsquo;est le cache qui sera utilis√© car OPcache n&rsquo;ira pas v√©rifier le contenu du fichier source. En production, il est donc pr√©f√©rable de laisser cette valeur √† 0 car sinon OPcache devra v√©rifier qu‚Äôil s‚Äôagit bien du m√™me fichier et cela consommera des I/O. Dans un environnement partag√© il est par contre plus prudent de laisser la valeur √† 1.</p>
<p>Si vous utilisez un outil de d√©ploiement tel que <strong>Capistrano</strong> qui utilise les <strong>liens symboliques</strong> pour faire un changement de release, il faudra donc bien penser √† <strong>vider le cache apr√®s une mise √† jour</strong>. De la m√™me fa√ßon, si vous utilisez des liens symboliques dans votre structure, il faudra bien penser √† vider OPcache apr√®s une nouvelle mise en prod.</p>
<h3 id="opcachemax_wasted_percentage">opcache.max_wasted_percentage</h3>
<p>Par d√©faut √† 5 %. Ce param√®tre d√©finit le <strong>taux de m√©moire g√¢ch√©e avant de lancer un restart d‚ÄôOPcache donc de PHP</strong>. Pour comprendre comment ce taux de m√©moire g√¢ch√©e est calcul√©, il faut comprendre comment OPcache g√®re sa m√©moire. C‚Äôest assez simple, pour √©viter la <strong>fragmentation de la m√©moire</strong>, lorsqu‚Äôun script qui est mis est cache est invalid√©, OPcache va <strong>reallouer de l‚Äôespace pour mettre en cache</strong> la nouvelle version et marquer l‚Äôancien espace m√©moire comme wasted. Il suffit ensuite de faire un ratio entre la m√©moire globale et la m√©moire g√¢ch√©e.</p>
<p>Si vous avez suivi les conseils que je vous ai donn√© pr√©c√©demment, ce seuil de 5 % ne devrait jamais √™tre un probl√®me car en prod, les fichiers seront invalid√©s manuellement et non par OPcache. Dans le cas d‚Äôun environnement partag√©, on peut monter un peu cette valeur pour √©viter des red√©marrages de PHP. Une fois de plus, il faut <strong>monitorer le nombre de red√©marrages</strong> li√©s √† cette variable.</p>
<h3 id="opcachesave_comments--opcacheload_comments">opcache.save_comments &amp; opcache.load_comments</h3>
<p>Par d√©faut ces param√®tres sont activ√©s. Ils permettent de d√©finir si les commentaires sont inclus dans le bytecode en cache et si ils sont lus lors de l‚Äôex√©cution. On pourrait se dire qu‚Äôil n‚Äôest pas n√©cessaire de les activer mais de nombreux framework font usage des commentaires comme Doctrine ou PHPUnit. On garde donc ces valeurs activ√©es partout, c‚Äôest plus sage.</p>
<h3 id="opcacheenable_file_override">opcache.enable_file_override</h3>
<p>Ce param√®tre qui est par d√©faut d√©sactiv√© permet lorsqu‚Äôil est activ√© d‚Äôutiliser le cache OPcache lors de l‚Äôappel des fonctions <strong>file_exists()</strong>, <strong>is_file()</strong> et <strong>is_readable()</strong>. Une fois de plus un param√®tre √† activer en prod quand on sait ce qu‚Äôon a derri√®re. Le mieux est donc de d√©finir cela avec les d√©veloppeurs. Quand on est dans un environnement partag√©, on le laisse d√©sactiver.</p>
<h3 id="file_update_protection">file_update_protection</h3>
<p>Un param√®tre non document√© mais qui a son importance, il s‚Äôagit du nombre de secondes qu‚Äôun fichier doit avoir avant de pouvoir √™tre mis en cache. Par d√©faut il est √† deux secondes. Pour √©viter qu‚Äôun script ne soit mis en cache il suffit donc de faire un touch avant de l‚Äôinclure. Cela n‚Äôest pas tr√®s utile mais c‚Äôest toujours bon √† savoir. Il existe d‚Äôautres moyens pour √©viter la mise en cache et on va tout de suite voir cela avec le param√®tre suivant.</p>
<h3 id="opcacheblacklist_filename">opcache.blacklist_filename</h3>
<p>On indique √† ce param√®tre un fichier (lisible par l‚Äôutilisateur PHP √©videmment) qui contiendra une liste de fichiers √† ne pas mettre en cache. On peut utiliser les <strong>;</strong> pour faire des commentaires dans le fichier et on peut √©galement utiliser le wildcard avec <strong>*</strong></p>
<p>Par exemple si on veut exclure tous les fichiers qui commencent par player on peut ajouter la ligne suivante dans notre liste :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">/home/plop/player/player*.php
</code></pre></div><p>Par exemple si je veux exclure mon r√©pertoire de dev qui est dans <strong>/home/mnttech/dev</strong> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">/home/mnttech/dev/
</code></pre></div><h3 id="opcachefast_shutdown">opcache.fast_shutdown</h3>
<p>Sur le papier c‚Äôest une bonne id√©e de l‚Äôactiver car cela permet de lib√©rer plus rapidement la m√©moire apr√®s un restart et donc de reprendre de nouvelles requ√™tes plus rapidement mais il semble que cela soit √† l‚Äôorigine de probl√®mes divers. Je vous laisse chercher sur le net, on trouve un tas d‚Äôexemples&hellip; Mieux vaut laisser cette option d√©sactiv√©e.</p>
<h3 id="vidage-du-cache">Vidage du cache</h3>
<p>Maintenant qu‚Äôon a fait le tour des param√®tres les plus importants, on va voir comment invalider le cache dans une logique de production. Pour faire simple, le mieux et le plus rapide est de reload votre pool fpm ou de faire un graceful d‚Äôapache.</p>
<p>Si vous utilisez mod_php avec apache :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">service apache2 graceful
</code></pre></div><p>Si vous utilisez un pool fpm :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">service php7.0-fpm reload
</code></pre></div><p>Il existe √©galement une autre fa√ßon de faire en appelant la fonction <strong>opcache_reset()</strong> depuis un curl ou via votre navigateur. Pourquoi je pr√©cise via curl ou le navigateur ? Car il faut savoir que <strong>la m√©moire en CLI n‚Äôest pas partag√©e avec la m√©moire de mod_php ou de votre pool fpm</strong>, et ce, m√™me si vous avez activ√© <strong>opcache.enable_cli</strong>. Il faut donc imp√©rativement passer par le web pour invalid√© le cache. Pour flusher le cache depuis un WordPress, j‚Äôai √©crit un plugin qui est disponible ici : <a href="https://fr.wordpress.org/plugins/flush-opcache/">WP-OPcache</a></p>
<p>Il existe une derni√®re m√©thode beaucoup plus fine, qui permet d‚Äôinvalider le cache pour un unique script, la fonction <strong>opcache_invalidate()</strong>. Elle pr√©sente le m√™me inconv√©nient que <strong>opcache_reset()</strong>, il faut la lancer depuis le web.</p>
<h3 id="tldr">TL;DR</h3>
<p><strong>En prod avec un rafra√Æchissement manuel du cache √† chaque d√©ploiement :</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">opcache.enable</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">opcache.enable_cli</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">opcache.validate_timestamps</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
<span style="color:#a6e22e">opcache.revalidate_path</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
<span style="color:#a6e22e">opcache.enable_file_override</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
</code></pre></div><p><strong>En dev :</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">opcache.enable</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">opcache.enable_cli</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">opcache.validate_timestamps</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">opcache.revalidate_freq</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
<span style="color:#a6e22e">opcache.revalidate_path</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
</code></pre></div><p><strong>Pour un h√©bergement partag√© ou de recette/test :</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#a6e22e">opcache.enable</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">opcache.enable_cli</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">opcache.validate_timestamps</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">opcache.revalidate_freq</span><span style="color:#f92672">=</span><span style="color:#e6db74">300 ;(5 minutes de cache)</span>
<span style="color:#a6e22e">opcache.revalidate_path</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">opcache.max_wasted_percentage</span><span style="color:#f92672">=</span><span style="color:#e6db74">25</span>
</code></pre></div><h3 id="supervision">Supervision</h3>
<p>Il y a diff√©rents points √† superviser pour s‚Äôassurer du bon fonctionnement d‚ÄôOPcache. Tous ces points sont √† <strong>ajouter dans votre outil d‚Äôalerting</strong> :</p>
<ul>
<li>Le ratio de cha√Ænes utilis√©es / cha√Ænes disponible</li>
<li>Le ratio de m√©moire utilis√©e / m√©moire totale</li>
<li>Le ratio de hits /misses</li>
<li>Le nombre de restart (oom_restarts et hash_restarts)</li>
</ul>
<p>Dans un prochain article je d√©taillerai la fa√ßon de mettre en place cette supervision via Nagios. Pour la partie m√©trique, je n‚Äôai encore rien mis en place dans Cacti √† ce sujet mais j‚Äôai vu qu‚Äôil y avait un template sur github que je testerai √† l‚Äôoccasion de ce futur article.</p>
<p><strong>Sources et liens utiles :</strong></p>
<ul>
<li><a href="http://php.net/manual/en/book.opcache.php">http://php.net/manual/en/book.opcache.php</a></li>
<li><a href="http://php.net/manual/en/intro.apcu.php">http://php.net/manual/en/intro.apcu.php</a></li>
</ul>





</article>



        </div> <!-- /.blog-main -->

        <aside class="col-sm-3 ml-auto blog-sidebar">

  <section class="sidebar-module sidebar-module-inset">
    <h4>√Ä propos</h4>
    <p dir="auto">J&rsquo;√©cris des articles autour de l&rsquo;univers SysAdmin/DevOps/SRE quand j&rsquo;en ai le temps et l&rsquo;envie.</p>
  </section>



        <section class="sidebar-module">
    <h4>Derniers billets</h4>
    <ol class="list-unstyled">


<li><a href="https://igln.fr/nouveau-blog-avec-hugo/">Nouveau blog avec hugo</a></li>

<li><a href="index.html">Fonctionnement et configuration d&rsquo;OPcache</a></li>

    </ol>
  </section>




</aside>


      </div> <!-- /.row -->
    </div> <!-- /.container -->



    <footer class="blog-footer">
      <p dir="auto">

      coucou, c&rsquo;est la fin de la page ! Fait avec <a href="https://gohugo.io/">hugo</a>

      </p>
      <p>
      <a href="index.html#">Haut de la page</a>
      </p>
    </footer>


  </body>

</html>
