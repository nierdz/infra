<!doctype html>
<html class="no-js" lang="fr">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Cloner une vm Xen avec LVM | MNT-TECH - Sysadmin blog</title>
		<link rel="canonical" href="index.html" />
		<link rel="shortcut icon" href="../../images/icons/favicon.png" />
		<link href='https://fonts.googleapis.com/css?family=Lato:300,400,700,900' rel='stylesheet' type='text/css'>
		<link rel="alternate" type="application/rss+xml" title="Cloner une vm Xen avec LVM Feed" href="../feed/index.html" />
		<link rel="stylesheet" href="../../css/foundation.css" />
		<link rel="stylesheet" href="../../css/font-awesome.min.css" />
		<link rel="stylesheet" href="../../css/animate.min.css" />
		<link rel="stylesheet" href="../../css/morphext.css" />
		<link rel="stylesheet" href="../../css/owl.carousel.css">
		<link rel="stylesheet" href="../../css/owl.theme.css" />
		<link rel="stylesheet" href="../../css/owl.transitions.css" />
		<link rel="stylesheet" href="../../css/slicknav.css" />
		<link rel="stylesheet" href="../../style.css" />
		<meta name="description" content="Ce tutoriel explique comment cloner une VM sous Xen qui est géré par LVM. Il suffit d'tiliser la fonction de snapshot de LVM qui permet de cloner très rapidement vos vm." />
		<meta property="og:title" content="Cloner une vm Xen avec LVM" />
		<meta property="og:type" content="article" />
		<meta property="og:url" content="https://mnt-tech.fr/blog/cloner-une-vm-xen-avec-lvm/" />
		<meta property="og:image" content="https://mnt-tech.fr/images/meta.jpg" />
		<meta property="og:site_name" content="MNT-TECH - Infogérance Serveur Linux OVH & Online" />
		<meta property="og:description" content="Ce tutoriel explique comment cloner une VM sous Xen qui est géré par LVM. Il suffit d'tiliser la fonction de snapshot de LVM qui permet de cloner très rapidement vos vm." />
		<meta property="article:tag" content="xen" />
		<meta property="article:tag" content="snapshot" />
		<meta property="article:tag" content="lvm" />
		<meta property="article:published_time" content="2014-02-28T12:51:57+00:00" />
		<meta property="article:modified_time" content="2014-02-28T12:51:57+00:00" />
		<meta name="twitter:card" content="summary" />
		<meta name="twitter:site" content="@mnttech" />
		<meta name="twitter:domain" content="mnt-tech.fr" />
		<meta name="twitter:title" content="Cloner une vm Xen avec LVM | MNT-TECH - Sysadmin blog" />
		<meta name="twitter:description" content="Ce tutoriel explique comment cloner une VM sous Xen qui est géré par LVM. Il suffit d'tiliser la fonction de snapshot de LVM qui permet de cloner très rapidement vos vm." />
		<meta name="twitter:image" content="https://mnt-tech.fr/images/meta.jpg" />
	</head>
<body>


<!--  HEADER -->
<header class="alt-2">
<div class="top">
	<div class="row">
		<div class="small-12 large-3 medium-3 columns">
			<div class="logo">
			<a href="../../index.html" title="Cloner une vm Xen avec LVM"><img src="../../images/logo.png" alt="Cloner une vm Xen avec LVM" title="Cloner une vm Xen avec LVM"/></a>
			</div>
		</div>
		<div class="small-12 large-9 medium-9 columns">

<!--  NAVIGATION MENU AREA -->
<nav class="desktop-menu">
	<ul class="sf-menu" id="navigation">
		<li class="current-menu-item"><a href="../page/1/index.html">BLOG</a></li>
	</ul>
</nav>
<!--  END OF NAVIGATION MENU AREA -->
		</div>
	</div>
</div>
<!--  MESSAGES ABOVE HEADER IMAGE -->
<div class="message">
	<div class="row">
		<div class="small-12 columns">
			<div class="message-intro">
				<span class="message-line"></span>
				<p>Blog</p>
				<span class="message-line"></span>
			</div>
			<h1>Cloner une vm Xen avec LVM</h1>
		</div>
	</div>
</div>
<!--  END OF MESSAGES ABOVE HEADER IMAGE -->
</header>
<!--  END OF HEADER -->

<!-- BLOG CONTENT -->
<div class="sectionarea blog">
	<div class="row">
		<div class="small-12 large-9 medium-9 columns">

			<!-- POST START -->
			<div class="entry">
			<div class="meta">Écrit le 28 02 2014</div>

				<p>Pour aujourd'hui, un petit tutoriel qui explique comment <strong>cloner une machine virtuelle Xen</strong> qui a son disque géré par LVM. Dans le fichier de configuration de votre vm, ça se traduit par une ligne qui ressemble à cela :</p>
<pre><code>
disk = [
		'phy:/dev/main/supervision.mnt-tech.fr-disk,xvda2,w',
		'phy:/dev/main/supervision.mnt-tech.fr-swap,xvda1,w',
]
</code></pre>
<p>On va donc commencer par utiliser la fonction de <strong>snapshot</strong> de <strong>LVM</strong> qui est très rapide car elle ne copie pas le volume mais uniquement les différences avec le volume original. Cela implique que si vous voulez changer environ 10Go sur votre snapshot par rapport à votre volume d'origine, il faudra dimensionner votre snapshot à 10Go. Pour plus de détails, vous pouvez consulter la <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/Logical_Volume_Manager_Administration/#snapshot_volumes" title="documentation redhat sur les snapshots LVM" target="_blank">documentation redhat sur les snapshots LVM</a>. Nous allons donc créer un snapshot de notre volume logique. Dans l'exemple, mon volume se nomme <strong>/dev/main/supervision.mnt-tech.fr-disk</strong> et je sais que je vais avoir 5Go grand maximum de différence avec mon volume d'origine. Je vais donc faire un snapshot de ce volume correspondant à mes besoins :</p>
<pre><code>
root@xen1:~# lvcreate -L5G -s -n 'node1.mnt-tech.fr-disk' /dev/main/supervision.mnt-tech.fr-disk
  Logical volume "node1.mnt-tech.fr-disk" created
</code></pre>
<p>On peut voir notre snapshot avec la commande suivante :</p>
<pre><code>
root@xen1:~# lvdisplay /dev/main/node1.mnt-tech.fr-disk
  --- Logical volume ---
  LV Path                /dev/main/node1.mnt-tech.fr-disk
  LV Name                node1.mnt-tech.fr-disk
  VG Name                main
  LV UUID                yrV8cf-xIfh-NAC4-PejZ-D2yR-5z21-TgFtjV
  LV Write Access        read/write
  LV Creation host, time xen1, 2014-02-28 12:00:50 +0100
  LV snapshot status     active destination for supervision.mnt-tech.fr-disk
  LV Status              available
  # open                 0
  LV Size                10.00 GiB
  Current LE             2560
  COW-table size         5.00 GiB
  COW-table LE           1280
  Allocated to snapshot  0.04%
  Snapshot chunk size    4.00 KiB
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           253:6
</code></pre>
<p>L'étape suivante n'est pas obligatoire, elle dépend de votre configuration. Dans mon cas, je met en dur les adresses IP de mes machines virtuelles dans le fichier de configuration à l'intérieur de la machine. Je vais donc devoir modifier l'adresse IP de ma machines virtuelle en montant le snapshot LVM avec <strong>kpartx</strong>.</p>
<pre><code>
root@xen1:~# kpartx -av /dev/main/node1.mnt-tech.fr-disk
root@xen1:~# mkdir temp
root@xen1:~# mount /dev/main/node1.mnt-tech.fr-disk temp/
root@xen1:~# vim temp/etc/network/interfaces
<strong>Faire les modifications sur votre interface</strong>
root@xen1:~# umount /dev/main/node1.mnt-tech.fr-disk
root@xen1:~# kpartx -d /dev/main/node1.mnt-tech.fr-disk
root@xen1:~# rmdir temp/
</code></pre>
<p>Il nous faut maintenant dupliquer le fichier de configuration de la vm et le modifier pour l'adapter à notre snapshot.</p>
<pre><code>
root@xen1:~# cp /etc/xen/supervision.mnt-tech.fr.cfg /etc/xen/node1.mnt-tech.fr.cfg
root@xen1:~# vim /etc/xen/node1.mnt-tech.fr.cfg
</code></pre>
<p>Dans le fichier de config <strong>/etc/xen/node1.mnt-tech.fr.cfg</strong> vous devez modifier l'adresse IP, l'adresse MAC, les volumes LVM à utiliser et le nom de la vm. Dans mon cas, j'ai modifié ceci : </p>
<pre><code>
disk = [
		'phy:/dev/main/node1.mnt-tech.fr-disk,xvda2,w',
		'phy:/dev/main/node1.mnt-tech.fr-swap,xvda1,w',
]
vif = [ 'ip=192.168.1.1 ,mac=00:16:3E:D3:F8:C4' ]
name = 'node1.mnt-tech.fr'
</code></pre>
<p>Et enfin, il ne reste plus qu'à lancer notre machine virtuelle :</p>
<pre><code>
root@xen1:~# xm create node1.mnt-tech.fr.cfg
Using config file "/etc/xen/node1.mnt-tech.fr.cfg".
Started domain node1.mnt-tech.fr (id=6)
</code></pre>

			</div>
			<!-- POST END -->

			<!-- SHARE -->
			<div class="single-section-container"><h5 class="single-section-title"><span class="single-section-text">♥ Partage sur tes réseaux sociaux ♥</span></h5></div>
			<div class="sharing-buttons">
				<ul>
					<li><a href="https://www.facebook.com/sharer/sharer.php?u=https://mnt-tech.fr/blog/cloner-une-vm-xen-avec-lvm/" title="Partage sur Facebook !" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i class="fa fa-facebook"></i></a></li>
					<li><a href="https://twitter.com/share/?url=https://mnt-tech.fr/blog/cloner-une-vm-xen-avec-lvm/&amp;via=mnttech" title="Partage sur Tweeter !" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i class="fa fa-twitter"></i></a></li>
					<li><a href="https://pinterest.com/pin/create/button/?url=https://mnt-tech.fr/blog/cloner-une-vm-xen-avec-lvm/" title="Partage sur Pinterest !" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i class="fa fa-pinterest"></i></a></li>
					<li><a href="https://plus.google.com/share?url=https://mnt-tech.fr/blog/cloner-une-vm-xen-avec-lvm/" title="Partage sur Google+ !" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;"><i class="fa fa-google-plus"></i></a></li>
				</ul>
			</div>
			<!-- END OF SHARE -->

			<!-- AUTHOR BOX -->
			<div class="author-wrap">
				<div class="row">
					<div class="small-12 large-2 medium-3 columns">
						<div class="author-gravatar"><img src="../../images/gravatar.png" alt="Kévin MET"/></div>
					</div>
					<div class="small-12 large-10 medium-9 columns">
						<div class="author-info">
							<div class="author author-title"><h6>Kévin MET</h6></div>
							<div class="author-description"><p>Auteur de ce blog et gérant de la société MNT-TECH, je publie sur ce blog lorsque le temps me le permet et lorsqu'un sujet qui me parait intéressant n'a pas encore été abordé en français. Toutes les informations techniques présentes sur cette page peuvent être réutilisées moyennant le fait de citer la source.</p></div>
						</div>
					</div>
				</div>
			</div>
			<!-- END OF AUTHOR BOX -->

		</div>
		<div class="small-12 large-3 medium-3 columns">


<!-- SIDEBAR -->
<div class="sidebar">
	<div class="widget">
	<h4 class="widget_title"><span>Categories</span></h4>
		<ul>
		<li><a href="../category/sysadmin/page/1/index.html" title="Sysadmin">Sysadmin</a></li>
		<li><a href="../category/dev/page/1/index.html" title="Dev">Dev</a></li>
		</ul>
	</div>
	<div class="widget">
	<h4 class="widget_title"><span>Recherche</span></h4>
		<form method="get" id="searchform" action="https://mnt-tech.fr/blog">
			<div class="row collapse">
				<div class="small-11 large-11 medium-11 columns">
					<input type="text" name="search" id="search">
				</div>
				<div class="small-1 large-1 medium-1 columns">
					<button type="submit" class="button tiny"><i class="fa fa-search"></i></button>
				</div>
			</div>
		</form>
	</div>
	<div class="widget">
		<h4 class="widget_title"><span>Un coup de pouce ?</span></h4>
		<div class="textwidget">
			<a href="../../index.html"><img src="../../images/headache.jpg" alt=""/></a>
		</div>
	</div>
	<div class="widget">
		<h4 class="widget_title"><span>TROP DE TAGS</span></h4>
		<div class="tagcloud">
						<a href="../tag/raid/index.html">raid</a>
			<a href="../tag/megacli/index.html">megacli</a>
			<a href="../tag/rtfm/index.html">rtfm</a>
			<a href="../tag/owncloud/index.html">owncloud</a>
			<a href="../tag/xen/index.html">xen</a>
			<a href="../tag/virtualisation/index.html">virtualisation</a>
			<a href="../tag/mysql/page/1/index.html">mysql</a>
			<a href="../tag/percona/index.html">percona</a>
			<a href="../tag/cluster/index.html">cluster</a>
			<a href="../tag/php/page/1/index.html">php</a>
			<a href="../tag/opcache/index.html">opcache</a>
			<a href="../tag/benchmark/page/1/index.html">benchmark</a>
			<a href="../tag/ovh/page/1/index.html">ovh</a>
			<a href="../tag/wordpress/page/1/index.html">wordpress</a>
			<a href="../tag/cms/index.html">cms</a>
			<a href="../tag/git/index.html">git</a>
			<a href="../tag/pub/index.html">pub</a>
			<a href="../tag/doitquick/index.html">doitquick</a>
			<a href="../tag/linux/page/1/index.html">linux</a>
			<a href="../tag/daa/index.html">daa</a>
			<a href="../tag/menu/index.html">menu</a>
			<a href="../tag/distribution/index.html">distribution</a>
			<a href="../tag/redhat/index.html">redhat</a>
			<a href="../tag/rpm/index.html">rpm</a>
			<a href="../tag/chroot/index.html">chroot</a>
			<a href="../tag/grub/index.html">grub</a>
			<a href="../tag/debian/page/1/index.html">debian</a>
			<a href="../tag/squid/index.html">squid</a>
			<a href="../tag/proxy/index.html">proxy</a>
			<a href="../tag/mysqldump/index.html">mysqldump</a>
			<a href="../tag/vpn/index.html">vpn</a>
			<a href="../tag/freelan/index.html">freelan</a>
			<a href="../tag/p2p/index.html">p2p</a>
			<a href="../tag/nagios/page/1/index.html">nagios</a>
			<a href="../tag/virtualmin/index.html">virtualmin</a>
			<a href="../tag/cacti/index.html">cacti</a>
			<a href="../tag/android/index.html">android</a>
			<a href="../tag/github/index.html">github</a>
			<a href="../tag/ssh/index.html">ssh</a>
			<a href="../tag/backup/index.html">backup</a>
			<a href="../tag/mydumper/index.html">mydumper</a>
			<a href="../tag/sidebar/index.html">sidebar</a>
			<a href="../tag/online/index.html">online</a>
			<a href="../tag/header/index.html">header</a>
			<a href="../tag/iptables/index.html">iptables</a>
			<a href="../tag/firewall/index.html">firewall</a>
			<a href="../tag/steam/index.html">steam</a>
			<a href="../tag/apache/index.html">apache</a>
			<a href="../tag/supervision/index.html">supervision</a>
			<a href="../tag/optimisation/index.html">optimisation</a>
			<a href="../tag/l2tp/index.html">l2tp</a>
			<a href="../tag/ipsec/index.html">ipsec</a>
			<a href="../tag/mail/index.html">mail</a>
			<a href="../tag/imap/index.html">imap</a>
			<a href="../tag/icinga/index.html">icinga</a>
			<a href="../tag/phpmyadmin/index.html">phpmyadmin</a>
			<a href="../tag/postfix/index.html">postfix</a>
			<a href="../tag/node/index.html">node</a>
			<a href="../tag/load-balancing/index.html">load-balancing</a>
			<a href="../tag/haproxy/index.html">haproxy</a>
			<a href="../tag/proxmox/index.html">proxmox</a>
			<a href="../tag/swap/index.html">swap</a>
			<a href="../tag/ram/index.html">ram</a>
			<a href="../tag/cron/index.html">cron</a>
			<a href="../tag/script/index.html">script</a>
			<a href="../tag/integrit/index.html">integrit</a>
			<a href="../tag/collectd/index.html">collectd</a>
			<a href="../tag/grafana/index.html">grafana</a>
			<a href="../tag/graphite/index.html">graphite</a>
			<a href="../tag/nginx/index.html">nginx</a>
			<a href="../tag/php-fpm/index.html">php-fpm</a>
			<a href="../tag/cache/index.html">cache</a>
			<a href="../tag/rsync/index.html">rsync</a>
			<a href="../tag/xtrabackup/index.html">xtrabackup</a>
			<a href="../tag/innobackupex/index.html">innobackupex</a>
			<a href="../tag/nsca/index.html">nsca</a>
			<a href="../tag/kernel/index.html">kernel</a>
			<a href="../tag/squeeze/index.html">squeeze</a>
			<a href="../tag/torrent/index.html">torrent</a>
			<a href="../tag/rtorrent/index.html">rtorrent</a>
			<a href="../tag/smartctl/index.html">smartctl</a>
			<a href="../tag/openvpn/index.html">openvpn</a>
			<a href="../tag/routage/index.html">routage</a>
			<a href="../tag/sysbench/index.html">sysbench</a>
			<a href="../tag/shortcode/index.html">shortcode</a>
			<a href="../tag/kimsufi/index.html">kimsufi</a>
			<a href="../tag/gitlist/index.html">gitlist</a>
			<a href="../tag/qcow2/index.html">qcow2</a>
			<a href="../tag/qemu/index.html">qemu</a>
			<a href="../tag/kvm/index.html">kvm</a>
			<a href="../tag/snapshot/index.html">snapshot</a>
			<a href="../tag/lvm/index.html">lvm</a>
			<a href="../tag/utf8/index.html">utf8</a>
			<a href="../tag/sendmail/index.html">sendmail</a>
			<a href="../tag/mailq/index.html">mailq</a>
			<a href="../tag/nrpe/index.html">nrpe</a>
			<a href="../tag/sip/index.html">sip</a>
		</div>
	</div>
</div>
<!-- END OF SIDEBAR -->

		</div>
	</div>
</div>
<!-- END OF CONTENT -->
<!--  FOOTER  -->
<footer>
<div class="row">
	<div class="small-12 columns">
		<div class="contacts">
			<div class="row">
				<div class="small-12 large-3 medium-3 columns">
					<a href="index.html#"><i class="fa fa-map-marker"></i></a>PARIS, FRANCE
				</div>
				<div class="small-12 large-3 medium-3 columns">
					<a href="index.html#"><i class="fa fa-mobile"></i></a>01 02 03 04 05
				</div>
				<div class="small-12 large-3 medium-3 columns">
					<a href="index.html#"><i class="fa fa-comments"></i></a>LIVE CHAT
				</div>
				<div class="small-12 large-3 medium-3 columns">
					<a href="index.html#"><i class="fa fa-envelope-o"></i></a>E-MAIL
				</div>
			</div>
		</div>
	</div>
</div>
<div class="row">
	<div class="small-12 columns">
		<div class="footerlinks" data-equalizer>
			<div class="small-12 large-3 medium-3 columns border-right" data-equalizer-watch>
				<h2>Infogérance</h2>
				<ul>
				</ul>
			</div>
			<div class="small-12 large-3 medium-3 columns border-right" data-equalizer-watch>
				<h2>Hébergement web dédié</h2>
				<ul>
				</ul>
			</div>
			<div class="small-12 large-3 medium-3 columns border-right" data-equalizer-watch>
				<h2>Liens & Projets</h2>
				<ul>
					<li><a href="../page/1/index.html">Blog</a></li>
					<li><a href="https://github.com/nierdz">Github</a></li>
				</ul>
			</div>
			<div class="small-12 large-3 medium-3 columns" data-equalizer-watch>
				<h2>Derniers articles</h2>
					<ul>
	<li><a href="../installation-collectd-graphite-grafana-partie-2/index.html">Installation de Collectd, Graphite et Grafana - Partie 2</a></li>
	<li><a href="../installation-collectd-graphite-grafana-partie-1/index.html">Installation de Collectd, Graphite et Grafana - Partie 1</a></li>
	<li><a href="../utiliser-fichier-conf-chiffre-client-mysql/index.html">Utiliser un fichier de conf chiffré pour le client mysql</a></li>
</ul>			</div>
			<!--End mc_embed_signup-->
		</div>
	</div>
</div>
<p class="copyright">© Copyright MNT-TECH</p>
</footer>
<!--  END OF FOOTER  -->
<a href="index.html#top" id="back-to-top"><i class="fa fa-angle-up"></i></a>
<script src="../../js/vendor/jquery.js"></script>
<script src="../../js/vendor/what-input.min.js"></script>
<script src="../../js/foundation.min.js"></script>
<script src="../../js/vendor/contact-script.js"></script>
<script src="../../js/vendor/hoverIntent.js"></script>
<script src="../../js/vendor/superfish.min.js"></script>
<script src="../../js/vendor/morphext.min.js"></script>
<script src="../../js/vendor/wow.min.js"></script>
<script src="../../js/vendor/jquery.slicknav.min.js"></script>
<script src="../../js/vendor/waypoints.min.js"></script>
<script src="../../js/vendor/jquery.animateNumber.min.js"></script>
<script src="../../js/vendor/owl.carousel.min.js"></script>
<script src="../../js/vendor/retina.min.js"></script>
<script src="../../js/custom.js"></script>
