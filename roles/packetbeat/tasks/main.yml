---
- name: Install packetbeat
  apt:
    name: "packetbeat={{ packetbeat_version }}"
    state: present
    update_cache: true
  register: packetbeat_installed
  until: packetbeat_installed is success
  retries: 10
  delay: 2

- name: Check if packetbeat keystore already exists
  stat:
    path: /var/lib/packetbeat/packetbeat.keystore
  register: packetbeat_keystore

- name: Create the keystore if it doesn't exist yet
  command: >
    /usr/bin/packetbeat
    keystore create
  when: not packetbeat_keystore.stat.exists

- name: Check if packetbeat password is already stored
  command: >
    /usr/bin/packetbeat
    keystore list
  register: packetbeat_keystore_list
  changed_when: false

- name: Store packetbeat password if needed
  shell: >
    set -o pipefail &&
    echo {{ packetbeat_password }} |
    /usr/bin/packetbeat
    keystore add PACKETBEAT_PASSWORD
    --stdin --force
  when: '"PACKETBEAT_PASSWORD" not in packetbeat_keystore_list.stdout'

- name: Create /etc/packetbeat/packetbeat.yml
  template:
    src: etc/packetbeat/packetbeat.yml.j2
    dest: /etc/packetbeat/packetbeat.yml
    owner: root
    group: root
    mode: 0644
  notify:
    - check packetbeat configuration
    - restart packetbeat

  # Bit dirty but didn't find proper way to get this
- name: Get system dashboard id
  command: >
    jq -r .objects[9].id /usr/share/packetbeat/kibana/7/dashboard/Packetbeat-overview.json
  register: dashboard_id
  changed_when: false

- name: Wait for kibana to be up
  uri:
    url: https://data.igln.fr:5601/status
    user: elastic
    password: "{{ elastic_password }}"
  retries: 30
  delay: 5
  register: result
  until: result.status == 200
  changed_when: false

- name: Check if setup is already done
  uri:
    url: http://94.23.24.201:9200/.kibana_1/_search
    user: elastic
    password: "{{ elastic_password }}"
    method: POST
    body_format: json
    body: '{ "query": { "match" : { "_id" : "visualization:{{ dashboard_id.stdout }}" } } }'
  register: kibana_dashboard
  failed_when: false

- name: Setup packetbeat
  command: >
    /usr/bin/packetbeat
    setup
  when: kibana_dashboard.json.hits.total.value is not defined or kibana_dashboard.json.hits.total.value != 1
  notify:
    - restart kibana
