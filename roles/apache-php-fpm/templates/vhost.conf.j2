<VirtualHost *:{{ apache_vhosts[item].port }}>
{% for item in apache_vhosts[item].parameters %}
	{{ item }}
{% endfor %}
{% if apache_vhosts[item].redirect_to_ssl is defined  and apache_vhosts[item].redirect_to_ssl %}
	RewriteEngine	On
	RewriteCond	%{SERVER_PORT} ^80$
	RewriteRule	^(.*)?$ https://%{SERVER_NAME}$1 [L,R]
{% endif %}
{% if apache_vhosts[item].root is defined %}
	DocumentRoot {{ apache_vhosts[item].root }}
{% endif %}
{% if apache_vhosts[item].SSLCertificateFile is defined and apache_vhosts[item].certbot is not defined %}
	SSLCertificateFile /etc/apache2/ssl/{{ apache_vhosts[item].SSLCertificateFile }}
{% endif %}
{% if apache_vhosts[item].SSLCertificateFile is defined and apache_vhosts[item].certbot is defined %}
	SSLCertificateFile {{ apache_vhosts[item].SSLCertificateFile }}
{% endif %}
{% if apache_vhosts[item].SSLCertificateKeyFile is defined and apache_vhosts[item].certbot is not defined %}
	SSLCertificateKeyFile /etc/apache2/ssl/{{ apache_vhosts[item].SSLCertificateKeyFile }}
{% endif %}
{% if apache_vhosts[item].SSLCertificateKeyFile is defined and apache_vhosts[item].certbot is defined %}
	SSLCertificateKeyFile {{ apache_vhosts[item].SSLCertificateKeyFile }}
{% endif %}
{% if apache_vhosts[item].SSLCACertificateFile is defined %}
	SSLCACertificateFile /etc/apache2/ssl/{{ apache_vhosts[item].SSLCACertificateFile }}
{% endif %}
{% if apache_vhosts[item].static is defined and apache_vhosts[item].static %}
	Include /etc/apache2/conf/expires.conf
{% endif %}
{% if apache_vhosts[item].php is defined and apache_vhosts[item].php %}
	<IfModule proxy_fcgi_module>
		<IfModule setenvif_module>
			SetEnvIfNoCase ^Authorization$ "(.+)" HTTP_AUTHORIZATION=$1
		</IfModule>
		<FilesMatch ".+\.ph(p[3457]?|t|tml)$">
		{% if apache_vhosts[item].user == "www-data" %}
			SetHandler "proxy:unix:/run/php/php7.0-fpm.sock|fcgi://{{ item }}"
		{% else %}
			SetHandler "proxy:unix:/run/php/php7.0-fpm-{{ apache_vhosts[item].user }}.sock|fcgi://{{ item }}"
		{% endif %}
		</FilesMatch>
		<FilesMatch ".+\.phps$">
			Require all denied
		</FilesMatch>
		<FilesMatch "^\.ph(p[3457]?|t|tml|ps)$">
			Require all denied
		</FilesMatch>
		<Proxy fcgi://{{ item }}>
			ProxySet connectiontimeout=5 timeout=30
		</Proxy>
	</IfModule>
{% endif %}
{% if apache_vhosts[item].root is defined %}
	<Directory {{ apache_vhosts[item].root }}>
	{% if apache_vhosts[item].htpasswd is not defined %}
	Require all granted
	{% endif %}
	AllowOverride All
	</Directory>
{% endif %}
	ErrorLog /var/log/apache2/{{ item }}_error.log
	CustomLog /var/log/apache2/{{ item }}_access.log combined
</VirtualHost>
