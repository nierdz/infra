server {
	{% for item in nginx_vhosts[item].parameters %}
{{ item }}
	{% endfor %}

	{% if nginx_vhosts[item].root is defined %}	
	root {{ nginx_vhosts[item].rootÂ }};
	{% endif %}
	
	index index.html index.php;
	access_log /var/log/nginx/{{ item }}_access.log;
	error_log /var/log/nginx/{{ item }}_error.log;

{% if nginx_vhosts[item].redirect_to_ssl is defined and nginx_vhosts[item].redirect_to_ssl %}
	return 301 https://$server_name$request_uri;
{% endif %}

{% if nginx_vhosts[item].ssl_certificate is defined and nginx_vhosts[item].certbot is not defined %}
	ssl_certificate /etc/nginx/ssl/{{ nginx_vhosts[item].ssl_certificate }};
{% endif %}
{% if nginx_vhosts[item].ssl_certificate is defined and nginx_vhosts[item].certbot is defined %}
	ssl_certificate {{ nginx_vhosts[item].ssl_certificate }};
{% endif %}
{% if nginx_vhosts[item].ssl_certificate_key is defined and nginx_vhosts[item].certbot is not defined %}
	ssl_certificate_key /etc/nginx/ssl/{{ nginx_vhosts[item].ssl_certificate_key }};
{% endif %}
{% if nginx_vhosts[item].ssl_certificate_key is defined and nginx_vhosts[item].certbot is defined %}
	ssl_certificate_key {{ nginx_vhosts[item].ssl_certificate_key }};
{% endif %}
{% if nginx_vhosts[item].ssl_trusted_certificate is defined and nginx_vhosts[item].certbot is not defined %}
	ssl_trusted_certificate /etc/nginx/ssl/{{ nginx_vhosts[item].ssl_trusted_certificate }};
{% endif %}
{% if nginx_vhosts[item].ssl_trusted_certificate is defined and nginx_vhosts[item].certbot is defined %}
	ssl_trusted_certificate {{ nginx_vhosts[item].ssl_trusted_certificate }};
{% endif %}

{% if nginx_vhosts[item].static is defined and nginx_vhosts[item].static %}
	location ~* ^.+\.(css|js|jpg|jpeg|gif|png|ico|svg)$ {
		add_header Pragma public;
		add_header Cache-Control "public";
		expires max;
	}
	location ~* ^.+\.(woff|eot)$ {
		expires max;
	}
{% endif %}

{% if nginx_vhosts[item].php is defined and nginx_vhosts[item].php %}
	location ~ \.php$ {
{% if nginx_vhosts[item].user == "www-data" %}
		fastcgi_pass unix:/run/php/php7.0-fpm.sock;
{% else %}
		fastcgi_pass unix:/run/php/php7.0-fpm-{{ nginx_vhosts[item].user }}.sock;
{% endif %}
		fastcgi_index index.php;
		include fastcgi_params;
	}
{% endif %}

{% if nginx_vhosts[item].try_files is defined %}
	location / {
		try_files {{ nginx_vhosts[item].try_files }};
	}
{% else %}
	location / {
		try_files $uri $uri/ =404;
	}
{% endif %}

	location ~ /.well-known {
		allow all;
	}

	location ~ /\.ht {
		deny all;
	}
}
