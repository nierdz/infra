#!/usr/bin/env bash
# {{ ansible_managed }}

set -o errexit
set -o pipefail
set -o nounset

DEBUG=${DEBUG:=0}
[[ $DEBUG -eq 1 ]] && set -o xtrace

DATABASES="ALL" # List of databases to backup separate by space. Use ALL to backup all databases except the system ones
MYSQLDUMP="/usr/bin/mysqldump"
MYSQL="/usr/bin/mysql"
GZIP="/bin/gzip"
TIME_TO_KEEP="{{ mysql_backup_docker.time_to_keep }}" # Time in days you want to keep old backups
MYSQLDUMP_OPT="" # Additional options for mysqldump; ie :  --ignore-table=db_name.tbl_name
DATE=$(date +%Y%m%d)
BACKUP_ROOT="/var/backups/mysql"
BACKUP_DIR="$BACKUP_ROOT/$DATE"
LOG="/var/log/mysql_backup.log"

# LOG
exec 1> $LOG
exec 2> $LOG

returncheck() {
  if [ "$1" -ne 0 ]
    then
      echo "$(date +"%Y-%m-%d %H:%M:%S") $2"
      echo "ERROR MySQL Backup: $2"
      exit 1
  fi
}

DOCKER="docker exec {{ mysql_backup_docker.container }}"
DOCKERI="docker exec -i {{ mysql_backup_docker.container }}"

# Check Mysql credentials
$DOCKER $MYSQL --silent --raw -e "SELECT @@hostname;"
returncheck $? "Impossible to connect to MySQL server"

# Create backup folder
if [ ! -d "$BACKUP_DIR" ]
then
  mkdir -p "$BACKUP_DIR"
  returncheck $? "Impossible to create backup folder"
fi

# Get list of databases to backup
if [ "$DATABASES" = "ALL" ]
then
  DATABASES=$($DOCKER $MYSQL --silent --raw -e "SHOW DATABASES;" | grep -v "Database\\|information_schema\\|mysql\\|performance_schema\\|sys")
  returncheck $? "Impossible to retrieve databases list"
fi

# Dump databases
for DB in $DATABASES
do
  $DOCKER $MYSQLDUMP ${MYSQLDUMP_OPT} --opt --routines --events "${DB}" > "${BACKUP_DIR}/${DB}.sql"
  returncheck $? "Impossible to backup database $DB"
done

# Create temporary databases to check dumps
for DB in $DATABASES
do
  $DOCKER $MYSQL --silent -e "CREATE DATABASE \`$DB$DATE\`;"
  returncheck $? "Impossible to create database \`$DB$DATE\`"
done

# Restore dumps in temporary databases
for DB in $DATABASES
do
  $DOCKERI $MYSQL "$DB$DATE" < "${BACKUP_DIR}/${DB}.sql"
  returncheck $? "Impossible to restore $DB in temporary \`$DB$DATE\`"
done

# Drop temporary databases
for DB in $DATABASES
do
  $DOCKER $MYSQL --silent -e "DROP DATABASE \`$DB$DATE\`;"
  returncheck $? "Impossible to drop database \`$DB$DATE\`"
done

# Gzip dumps
for DB in $DATABASES
do
  ${GZIP} -f "${BACKUP_DIR}/${DB}.sql"
  returncheck $? "Impossible to zip database $DB"
done

# Delete old backups
find "${BACKUP_ROOT}" -type d -mtime +"${TIME_TO_KEEP}" -exec rm -r {} \;
returncheck $? "Impossible to delete old backups"
